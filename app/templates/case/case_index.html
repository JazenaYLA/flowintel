<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block content %}
    <h1>
        List of Case
        <span>
            <a class="btn btn-primary btn-small" href="/case/add"><i class="fa-solid fa-plus"></i></a>
        </span>
    </h1>

    <case_filter @cases_list="(cases) => case_list.cases = cases['cases']"></case_filter>

    <hr>

    <template v-if="case_list">
        <template v-for="case_loc in case_list.cases">
            <div class="list-group" style="margin-bottom: 20px;">
                <div style="display:flex">
                    <a :href="`/case/view/${case_loc.id}`" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h4 class="mb-1">[[ case_loc.id ]]-[[ case_loc.title ]]</h4>
                            <small><i>Changed [[ moment(case_loc.last_modif).fromNow() ]]</i></small>
                        </div>
                        <div class="d-flex w-100 justify-content-between">
                            <p v-if="case_loc.description" class="card-text">[[ case_loc.description ]]</p>
                            <p v-else class="card-text"><i style="font-size: 12px;">No description</i></p>

                            <small v-if="status_info"><span :class="'badge rounded-pill text-bg-'+status_info.status[case_loc.status_id -1].bootstrap_style">[[ status_info.status[case_loc.status_id -1].name ]]</span></small>
                        </div>
                        <div class="d-flex w-100 justify-content-between">
                            <div class="d-flex w-100 justify-content-between">
                                <div></div>
                                <small v-if="case_loc.dead_line" :title="case_loc.dead_line"><i>Dead line [[moment(case_loc.dead_line).endOf().fromNow()]]</i></small>
                                <small v-else><i>No dead line</i></small>
                            </div>
                        </div>
                    </a>
                    <div v-if="!case_loc.current_user_permission.read_only && case_loc.present_in_case" style="display: grid;">
                        <button class="btn btn-success btn-sm"  @click="complete_case(case_loc, case_list.cases)" title="Complete the case"><i class="fa-solid fa-check"></i></button>
                        <a class="btn btn-primary btn-sm" :href="`/case/edit/${case_loc.id}`" type="button" title="Edit the case"><i class="fa-solid fa-pen-to-square"></i></a>
                        <button class="btn btn-danger btn-sm"  @click="delete_case(case_list, case_loc)" title="Delete the case"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </template>

    </template>

    
    
	
{% endblock %}

{% block script %}
    <script type="module">
        const { createApp, ref } = Vue
        import case_filter from '../../static/js/case/case_filter.js'
        
        createApp({
            delimiters: ['[[', ']]'],
            components: {
                case_filter
            },
            setup() {
                const case_list = ref(null)
                const status_info = ref(null)

                async function fetchCase() {
                    case_list.value = null
                    const res = await fetch(
                        'case/get_cases'
                    )
                    case_list.value = await res.json()
                }

                async function fetchStatus() {
                    status_info.value = null
                    const res = await fetch(
                        '/case/get_status'
                    )
                    status_info.value = await res.json()
                }

                function delete_case(case_list, case_loc){
                    fetch(
                        '/case/delete',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"case_id": case_loc.id.toString()})
                        }
                    )

                    let index = case_list.cases.indexOf(case_loc)
                    if(index > -1)
                        case_list.cases.splice(index, 1)
                }

                function complete_case(case_loc, cases_list){
                    case_loc.last_modif = Date.now()
                    case_loc.completed = !case_loc.completed
                    fetch('/case/complete_case/'+case_loc.id)

                    if(status_info.value.status[case_loc.status_id -1].name == 'Finished'){
                        for(let i in status_info.value.status){
                            if(status_info.value.status[i].name == 'Revive')
                            case_loc.status_id = status_info.value.status[i].id
                        }
                        if(case_loc.status_id == status)
                            case_loc.status_id = 1

                        fetch('/case/change_status/'+case_loc.id,{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"status": case_loc.status_id})
                        })
                    }else{
                        for(let i in status_info.value.status){
                            if(status_info.value.status[i].name == 'Finished'){
                                case_loc.status_id = status_info.value.status[i].id
                                fetch('/case/change_status/'+case_loc.id,{
                                    headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                    method: "POST",
                                    body: JSON.stringify({"status": case_loc.status_id})
                                })
                                break
                            }
                        }
			}

                    let index = cases_list.indexOf(case_loc)
                    if(index > -1)
                        cases_list.splice(index, 1)
                }

                fetchCase()
                fetchStatus()

                return {
                    case_list,
                    status_info,
                    delete_case,
                    complete_case,
                    moment
                }
            }
        }).mount('.container')

    </script>
{% endblock %}