<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block head %}
<script src="{{ url_for('static',filename='js/markdown-it.js') }}"></script>
<script src="{{ url_for('static',filename='js/editor.js') }}"></script>
<script src="{{ url_for('static',filename='js/mermaid-markdown.js') }}"></script>

{{ super() }}
{%endblock%}

{% block content %}
    <div id="top"></div>
    <span>
        <h1 style="display: inline-block; font-size: xxx-large;"><a type="button" class="btn" href="/case"><i class="fa-solid fa-arrow-left"></i></a></h1>

        <h1 style="display: inline-block; font-size: xx-large;">{{case.id}}- {{case.title}}</h1>
        <!-- lock icon -->
        <span v-if="cases_info" style="font-size: 12px; margin-left: 5px; position: absolute; margin-top: 11px;">
            <i v-if="cases_info.case.is_private" class="fa-solid fa-lock" title="The case is private, only org present in can see this case"></i>
            <i v-else class="fa-solid fa-unlock" title="The case is public anyone can see this case but only org present in case can modify it"></i>
        </span>
        <!-- uuid -->
        <span><i style="font-size: 12px; margin-left: 5px;">{{case.uuid}}</i></span>
        <!-- status -->
        <small v-if="status_info" style="margin-left: 10px;">
            <span :class="'badge rounded-pill text-bg-'+status_info.status[{{case.status_id}} -1].bootstrap_style" id="id-case-status">
                [[ status_info.status[ {{case.status_id}} -1].name ]]
            </span>
        </small>
    </span>
    
    <!-- Link to other case -->
    <template v-if="cases_info">
        <button type="button" title="Link to other Case" class="btn btn-outline-primary btn-sm" data-bs-toggle="dropdown" aria-expanded="false" style="margin-left: 10px;">
            <i class="fa-solid fa-paperclip"></i> <span class="badge text-bg-secondary" style="z-index: -1;">[[cases_info.case.link_to.length]]</span>
        </button>
        <ul class="dropdown-menu">
            <button class="btn btn-primary btn-sm" title="New link" style="margin-left: 60px;" data-bs-toggle="modal" data-bs-target="#add_new_link">
                <i class="fa-solid fa-paperclip"></i>+
            </button>
            <li><hr class="dropdown-divider"></li>
            <template v-for="case_link in cases_info.case.link_to">
                <li>
                    <div class="d-flex">
                        <a class="dropdown-item" :href="'/case/'+case_link.id" style="margin-right: 5px;" :title="case_link.description">[[case_link.title]]</a>
                        <button class="btn btn-danger btn-sm" @click="remove_case_link(cases_info, case_link)">Remove</button>
                    </div>
                </li>
            </template>
        </ul>
    </template>
  
    <!-- Modal add new link -->
    <div class="modal fade" id="add_new_link" tabindex="-1" aria-labelledby="add_new_link_modal" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="add_new_link_modal">Add New link</h1>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Link to:
                    <select class="new-link-ajax" name="link_to" tabindex="-1" multiple data-placeholder="Link To"></select>
                    <div style="color: brown;" id="add_new_link_error"></div>
                </div>
                <div class="modal-footer">
                    <button @click="submit_add_new_link()" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Components that contains all button that provide an action on the case -->
    <action_buttons 
        :cases_info="cases_info"
        :status_info="status_info">
    </action_buttons>

    {% if case.custom_tags %}
        <div style="display: flex; margin-bottom: 5px;">
            {% for tag in case.custom_tags %}
                <div class="tag" :style="{'background-color': '{{tag.color}}', 'color': getTextColor('{{tag.color}}')}">
                    {% if tag.icon %}
                        <i class="{{tag.icon}}"></i>
                    {%endif%}
                    {{tag.name}}
                </div>
            {%endfor%}
        </div>
    {%endif%}

    {% if case.tags %}
        <div style="display: flex;">
            {% for tag in case.tags%}
                <div class="tag" title="{{tag.description}}" :style="{'background-color': '{{tag.color}}', 'color': getTextColor('{{tag.color}}')}">
                    <i class="fa-solid fa-tag" style="margin-right: 3px; margin-left: 3px;"></i>
                    {{tag.name}}
                </div>
            {%endfor%}
        </div>
    {%endif%}

    <div style="margin-top: 5px;">
        {% if case.clusters %}
            {% for cluster in case.clusters %}
                <div title="Description: &#013;{{cluster.description}}&#013;&#013; Metadata: &#013;{{cluster.meta}}">
                    <span class="cluster">
                        <span v-html="mapIcon('{{cluster.icon}}')"></span>
                        {{cluster.tag}}
                    </span>
                </div>
            {%endfor%}
        {%endif%}
    </div>

    <br>

    <!-- Connectors & MISP Objects -->
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConnectors" aria-expanded="false" aria-controls="collapseConnectors">
        <i class="fa-solid fa-link"></i> Connectors
    </button>
    <button class="btn btn-outline-primary ms-1" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMispObject" aria-expanded="false" aria-controls="collapseMispObject">
        <i class="fa-solid fa-cubes"></i> MISP objects
        <span class="badge text-bg-secondary d-none" id="id-nb-misp-object">[[nb_misp_objects]]</span>
    </button>

    <template v-if="cases_info">
        <div class="collapse" id="collapseConnectors">
            <caseconnectors 
                :case_task_connectors_list="case_connectors_list"
                :all_connectors_list="all_connectors_list"
                :modules="modules"
                :is_case="true"
                :object_id="cases_info.case.id"
                :cases_info="cases_info"
                @case_connectors="(msg) => fetch_case_connectors()"
                @task_connectors="">
            </caseconnectors>
        </div>
    </template>

    <misp_object :case_id="{{case.id}}" @modif_misp_objects="(msg) => fetch_nb_misp_objects()"></misp_object>

    <div class="d-flex w-100 justify-content-between" v-if="cases_info" style="margin-top: 10px;">
        <i :title="cases_info.case.creation_date">Created: [[ dayjs.utc( cases_info.case.creation_date ).fromNow() ]]</i>
        <i :title="cases_info.case.last_modif">Changed: [[ dayjs.utc( cases_info.case.last_modif ).fromNow() ]]</i>
        {% if case.deadline %}
            <i :title="cases_info.case.deadline">Deadline: [[ dayjs.utc( cases_info.case.deadline ).endOf().fromNow() ]]</i>
        {%endif%}
    </div>
    {%if case.recurring_type %}
        <div class="d-flex w-100 justify-content-between" v-if="cases_info" style="margin-top: 10px;">
            <i>Recurring type: {{case.recurring_type}}</i>
            {%if case.recurring_date %}
                <i :title="cases_info.case.last_modif">Recurring Date: {{case.recurring_date}}</i>
            {%endif%}
        </div>
    {%endif%}

    <!-- Component to manage orgs -->
    <manage_orgs :cases_info="cases_info"></manage_orgs>

    
    {% if case.description %}
    <div>
        <hr>
        <!-- <pre style="font-family: var(--bs-font-sans-serif);font-size: var(--bs-body-font-size);font-weight: var(--bs-body-font-weight);">{{case.description}}</pre> -->
        <pre>{{case.description}}</pre>
    </div>
    {%endif%}
    
    <hr style="margin-bottom: 40px;">

    <ul class="nav nav-tabs" style="margin-bottom: 10px;">
        <li class="nav-item">
            <button class="nav-link active" id="tab-main" aria-current="page" @click="active_tab('main')">Main</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-history" @click="active_tab('history')">History</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-case" @click="active_tab('case')">Case notes</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-all" @click="active_tab('all')">Tasks notes</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-hedgedoc" @click="active_tab('hedgedoc')">Hedgedoc</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-info" @click="active_tab('info')">Info</button>
        </li>
    </ul>


    <template v-if="main_tab == 'main'">
        <div style="display: flex;">
            <h3>Tasks</h3>
            {% if not current_user.read_only() and present_in_case or current_user.is_admin() %}
                <span style="padding-left: 10px;">
                    <a href="/case/{{case.id}}/create_task" class="btn btn-primary"><i class="fa-solid fa-plus"></i></a>
                </span>
            {%endif%}

            <!-- Search bar -->
            <div class="input-group w-auto start-50 translate-middle-x">
                <input autocomplete="off" @input="onInput" type="search" class="form-control rounded" placeholder='Search task by title' style="min-width: 400px;" />
            </div>
            <!-- Search bar -->
        </div>
        <div style="margin-top: -5px; margin-bottom: 15px;">
            <small><i>[[open_closed.open]] open/ [[open_closed.closed]] closed</i></small>
        </div>

        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapsefiltertask" aria-expanded="false" aria-controls="collapsefiltertask">
            filter
        </button>
        <div class="collapse" id="collapsefiltertask">
            <div class="card card-body">
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioStatus" id="radioStatusOngoing" @click="change_status_sort(false)" checked>
                            <label class="form-check-label" for="radioStatusOngoing">Ongoing Tasks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioStatus" id="radioStatusFinished" @click="change_status_sort(true)">
                            <label class="form-check-label" for="radioStatusFinished">Finished Tasks</label>
                        </div>
                    </div>

                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherTitle" @click="sort_by_filter('title')" checked>
                            <label class="form-check-label" for="radioOtherTitle">Title</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOrderAsc" @click="sort_by_filter('last_modif')">
                            <label class="form-check-label" for="radioOrderAsc">Last Modif</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherDeadLine" @click="sort_by_filter('deadline')">
                            <label class="form-check-label" for="radioOtherDeadLine">Deadline</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherStatus" @click="sort_by_filter('status_id')">
                            <label class="form-check-label" for="radioOtherStatus">Status</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherAssign" @click="sort_by_filter('assigned_tasks')">
                            <label class="form-check-label" for="radioOtherAssign">Assigned tasks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherCurrentAssign" @click="sort_by_filter('my_assignment')">
                            <label class="form-check-label" for="radioOtherCurrentAssign">My assignment</label>
                        </div>
                    </div>

                    <div>
                        Change order
                        <div class="form-check form-switch" style="margin-left: 35%;">
                            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" @click="change_switch_check(true)">
                        </div>
                    </div>
                </div>
                <hr>
                <div>Taxonomies:</div>
                <div class="d-flex w-100 justify-content-center">
                    <div style="display:flex">
                        <span style="margin-right: 10px">OR</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switchOperator" @click="change_switch_check(false,true)">
                            <label class="form-check-label" for="switchOperator">AND</label>
                        </div>
                    </div>
                </div>
                <div style="display: flex;">
                    <template v-if="taxonomies">
                        <select data-placeholder="Taxonomies" class="select2-select form-control" multiple name="taxonomies_select" id="taxonomies_select" >
                            <template v-for="taxonomy, key in taxonomies">
                                <option :value="[[taxonomy]]">[[taxonomy]]</option>
                            </template>
                        </select>
                    </template>
                    
                    <template v-if="tags_list">
                        <select data-placeholder="Tags" class="select2-select form-control" multiple name="tags_select" id="tags_select" >
                            <template v-for="(tags, taxo) in tags_list">
                                <optgroup :label="[[taxo]]">
                                    <option :value="[[tag.name]]" v-for="tag in tags">[[tag.name]]</option>
                                </optgroup>
                            </template>
                        </select>
                    </template>
                </div>
                <hr>

                <div>Galaxies:</div>
                <div class="d-flex w-100 justify-content-center">
                    <div style="display:flex">
                        <span style="margin-right: 10px">OR</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switchOperator" @click="change_switch_check(false, false, true)">
                            <label class="form-check-label" for="switchOperator">AND</label>
                        </div>
                    </div>
                </div>
                <div style="display: flex;">
                    <template v-if="galaxies">
                        <select data-placeholder="Galaxies" class="select2-select form-control" multiple name="galaxies_select" id="galaxies_select" >
                            <template v-for="galaxy, key in galaxies">
                                <option :value="[[galaxy.name]]">[[galaxy.name]]</option>
                            </template>
                        </select>
                    </template>
                    
                    <template v-if="cluster_list">
                        <select data-placeholder="Cluster" class="select2-select form-control" multiple name="clusters_select" id="clusters_select" >
                            <template v-for="(clusters, galaxy) in cluster_list">
                                <optgroup :label="[[galaxy]]">
                                    <option :value="[[cluster.name]]" :title="cluster.description" v-for="cluster in clusters">[[cluster.tag]]</option>
                                </optgroup>
                            </template>
                        </select>
                    </template>
                </div>
                
                <hr>

                <div>Custom Tags:</div>
                <div>
                    <template v-if="custom_tags">
                        <select data-placeholder="Custom Tags" class="select2-select form-control" multiple name="custom_tags_select" id="task_custom_tags_select" >
                            <template v-for="custom_tag, key in custom_tags">
                                <option :value="[[custom_tag.name]]">[[custom_tag.name]]</option>
                            </template>
                        </select>
                    </template>
                </div>
            </div>
        </div>

        <hr>

        <template v-if="cases_info && cases_info.tasks && status_info" >
            <template v-for="task, key in cases_info.tasks" :key="task.id">
                <div :id="`task-${task.id}`" class="list-group" style="margin-bottom: 20px;">
                    <case_tasks :cases_info="cases_info" 
                                :users_in_case="users_in_case" 
                                :status_info="status_info" 
                                :task="task" 
                                :key_loop="key"
                                :open_closed="open_closed"
                                :md="md"
                                :all_connectors_list="all_connectors_list"
                                :task_modules="task_modules">
                    </case_tasks>
                </div>
            </template>
        </template>
        <template v-else>
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </template>
    </template>




    <template v-else-if="main_tab == 'history'">
        <template v-if="history">
            <a class="btn btn-primary btn-sm mb-1" :href="'/case/'+cases_info.case.id+'/download_history'">Download</a>
            <div v-for="h in history">
                [[h]]
            </div>
        </template>
        <template v-else>
            <i>No history</i>
        </template>
    </template>

    <template v-else-if="main_tab == 'case'">
        <div v-if="cases_info.case.notes">
            <template v-if="edit_mode">
                <button class="btn btn-primary" @click="save_note_case()">Save</button>
                <div style="display: flex;">
                    <div style="background-color: white; border-width: 1px; border-style: solid; width: 50%" id="editor"></div>
                    <div style="background-color: white; border: 1px #515151 solid; padding: 5px; width: 50%" v-html="md.render(note_editor_render)"></div>
                </div>
            </template>
            <template v-else>
                <button class="btn btn-primary btn-sm" @click="edit_note()">Edit</button>
                <div class="btn-group">
                    <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="margin-bottom: 1px;">
                        <small><i class="fa-solid fa-download"></i></small> Export
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <button v-if="!is_exporting" class="btn btn-link" @click="export_notes(cases_info.case.id, 'pdf')" title="Export markdown as pdf">PDF</button>
                            <button v-else class="btn btn-link" disabled>
                                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                <span role="status">Loading...</span>
                            </button>
                        </li>
                        <li>
                            <button v-if="!is_exporting" class="btn btn-link" @click="export_notes(cases_info.case.id, 'docx')" title="Export markdown as docx">DOCX</button>
                            <button v-else class="btn btn-link" disabled>
                                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                <span role="status">Loading...</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div v-html="md.render(cases_info.case.notes)" style="background-color: white; border: 1px rgb(176, 171, 171) solid; padding: 5px; border-radius: 5px; margin-top: 3px;"></div>
            </template>
        </div>
        <template v-else>
            <button class="btn btn-primary" @click="save_note_case()">Save</button>
            <div style="display: flex;">
                <div style="background-color: white; border-width: 1px; border-style: solid; width: 50%" id="editor"></div>
                <div style="background-color: white; border: 1px #515151 solid; padding: 5px; width: 50%" v-html="md.render(note_editor_render)"></div>
            </div>
        </template>

    </template>

    <template v-else-if="main_tab == 'all'">
        <template v-for="notes in all_notes">
            <div class="all-tasks-notes" v-html="md.render(notes)"></div>
        </template>
    </template>

    <template v-else-if="main_tab == 'hedgedoc'">
        <hedgedoc_template 
            :cases_info="cases_info"
            :status_info="status_info">
        </hedgedoc_template>
    </template>

    <template v-else-if="main_tab == 'info'">
        <div class="row">
            <div class="col-auto">
                <fieldset class="analyzer-select-case" style="text-align: center;">
                    <legend class="analyzer-select-case">Time required</legend>
                    <i>[[cases_info.case.time_required]]</i>
                </fieldset>
            </div>
            <div class="col-auto">
                <fieldset class="analyzer-select-case" style="text-align: center;">
                    <legend class="analyzer-select-case">Visibility</legend>
                    <i v-if="cases_info.case.is_private">Private</i>
                    <i v-else>Public</i>
                </fieldset>
            </div>
        </div>
    </template>

    <span id="createTask" title="Create a new task">
        <a href="/case/{{case.id}}/create_task" class="btn btn-outline-primary" style="border-radius: 50px;">
            <i class="fa-solid fa-plus"></i>
        </a>
    </span>
    <span id="goTop"><a href="#top" class="btn btn-outline-primary"><i class="fa-solid fa-chevron-up"></i></a></span>
{% endblock %}




{% block script %}
    <script type="module">
        const { createApp, ref, computed, nextTick, onMounted } = Vue
        import case_tasks from '/static/js/case/case_tasks.js'
        import hedgedoc_template from '/static/js/case/hedgedoc_template.js'
        import action_buttons from '/static/js/case/action_buttons.js'
        import manage_orgs from '/static/js/case/manage_orgs.js'
        import misp_object from '/static/js/case/misp_object.js'
        import caseconnectors from '/static/js/case/CaseConnectors.js'
        import {display_toast, message_list} from '/static/js/toaster.js'
        
        createApp({
            delimiters: ['[[', ']]'],
            components: {
                case_tasks,
                hedgedoc_template,
                action_buttons,
                manage_orgs,
                misp_object,
                caseconnectors
            },
            setup() {
                const cases_info = ref(null)
                const status_info = ref(null)
                const users_in_case = ref(null)
                const is_exporting = ref(false)
                let loc_tasks_list = []

                let completed = false
                let current_filter = ""
                let asc_desc = true
                let or_and_taxo = true
                let or_and_galaxies = true

                const main_tab = ref('main')
                const history = ref(null)

                const taxonomies = ref([])
                const tags_list = ref([])
                const selected_taxo = ref([])
                const selected_tags = ref([])

                const galaxies = ref([])
                const cluster_list = ref([])
                const selected_galaxies = ref([])
                const selected_clusters = ref([])

                const custom_tags = ref([])
                const selected_custom_tags = ref([])

                const case_connectors_list = ref([])
                const all_connectors_list = ref([])
                const modules = ref()
                const task_modules = ref()

                const nb_misp_objects = ref(0)

                const open_closed = ref({})
                const all_notes = ref("")
                let editor
                const note_editor_render = ref("")
                const edit_mode = ref(false)

                const md = window.markdownit()			// Library to Parse and display markdown
		        md.use(mermaidMarkdown.default)			// Use mermaid library

                const case_for_link = ref([])

                async function fetch_history(){
                    const res = await fetch("/case/history/" + cases_info.value.case.id)
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        history.value = loc["history"]
                    }
                }

                async function fetch_open_closed(){
                    const res = await fetch("/case/get_open_close/"+cases_info.value.case.id)
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        open_closed.value = loc
                    }
                }

                async function fetch_case_connectors(){
                    const res = await fetch("/case/"+ window.location.pathname.split("/").slice(-1) +"/get_case_connectors")
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        case_connectors_list.value = loc["case_connectors"]
                    }
                }
                async function fetch_connectors(){
                    const res = await fetch("/case/get_connectors")
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        all_connectors_list.value = loc["connectors"]
                    }
                }
                fetch_connectors()

                async function fetch_modules(){
                    // Get modules and instances linked on
                    const res = await fetch("/case/get_case_modules")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        modules.value = loc["modules"]
                    }
                }
                fetch_modules()

                async function fetch_task_modules(){
                    // Get modules and instances linked on
                    const res = await fetch("/case/get_task_modules")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        task_modules.value = loc["modules"]
                    }
                }
                fetch_task_modules()

                async function export_notes(case_id, type){
                    // Export notes in different format and download it
                    is_exporting.value = true
                    let filename = ""
                    await fetch('/case/'+case_id+'/export_notes?type=' + type)
                    .then(res =>{
                        filename = res.headers.get("content-disposition").split("=")
                        filename = filename[filename.length - 1]
                        return res.blob() 
                    })
                    .then(data =>{
                        var a = document.createElement("a")
                        a.href = window.URL.createObjectURL(data);
                        a.download = filename;
                        a.click();
                    })
                    is_exporting.value = false
                }

                async function change_status_sort(status){
                    completed = status
                    await fetch_sorted_tasks()
                }

                function change_switch_check(change=false, changeOperator=false, changeOperatorGalaxies=false){
                    if (change) asc_desc = !asc_desc
                    if (changeOperator) or_and_taxo = !or_and_taxo
                    if (changeOperatorGalaxies) or_and_galaxies = !or_and_galaxies

                    fetch_sorted_tasks()
                }

                async function fetch_sorted_tasks() {
                    let loc_status = `status=${completed}`
                    let loc_filter = `&filter=${current_filter}`
                    let loc_or_and_taxo = `&or_and_taxo=${or_and_taxo}`
                    let loc_or_and_galaxies = `&or_and_galaxies=${or_and_galaxies}`

                    let tags = ""
                    let taxo = ""
                    let galax = ""
                    let clusters = ""
                    let custom_tg = ""
                    if(selected_tags.value.length) tags = "&tags=" + JSON.stringify(selected_tags.value)
                    if(selected_taxo.value.length) taxo = "&taxonomies=" + JSON.stringify(selected_taxo.value)
                    if(selected_galaxies.value.length) galax = "&galaxies=" + JSON.stringify(selected_galaxies.value)
                    if(selected_clusters.value.length) clusters = "&clusters=" + JSON.stringify(selected_clusters.value)
                    if(selected_custom_tags.value.length) custom_tg = "&custom_tags=" + JSON.stringify(selected_custom_tags.value)

                    let url = `/case/${cases_info.value.case.id}/sort_tasks?${loc_status}${loc_filter}${loc_or_and_taxo}${loc_or_and_galaxies}${tags}${taxo}${galax}${clusters}${custom_tg}`
                    
                    const res = await fetch(url)
                    let loc = await res.json()

                    if(asc_desc)
                        cases_info.value.tasks = loc.reverse()
                    else
                        cases_info.value.tasks = loc

                    loc_tasks_list = cases_info.value.tasks
                }

                function sort_by_filter(filter){
                    current_filter = filter
                    fetch_sorted_tasks()
                }


                async function fetchCase() {
                    cases_info.value = null
                    const res = await fetch(
                        window.location.pathname.split("/").slice(-1)+'/get_case_info'
                    )

                    if(await res.status == 404){
                        display_toast(res)
                    }else{
                        cases_info.value = await res.json()
                        loc_tasks_list = cases_info.value.tasks
                        fetch_history()
                        await nextTick()
                        scrollIntoSelectedElement()
                        fetch_open_closed()
                        fetch_nb_misp_objects()

                        $('.select2-select-add-orgs').select2({
                            theme: 'bootstrap-5',
                            width: '50%'
                        })
                    }
                }
                fetchCase()

                async function fetchStatus() {
                    status_info.value = null
                    const res = await fetch(
                        '/case/get_status'
                    )
                    status_info.value = await res.json()
                }
                fetchStatus()

                async function get_all_users_case(){
                    users_in_case.value = null
                    const res = await fetch('/case/' + window.location.pathname.split("/").slice(-1) + '/get_all_users')
                    if(await res.status == 404){
                        display_toast(res)
                    }else{
                        users_in_case.value = await res.json()
                    }
                }
                get_all_users_case()

                function onInput(e){
                    cases_info.value.tasks = []
                    if(e.target.value){
                        cases_info.value.tasks = loc_tasks_list.filter((task) => {
                            return task.title.toLowerCase().includes(e.target.value.toLowerCase())
                        })
                    }else{
                        cases_info.value.tasks = fetch_sorted_tasks()
                    }
                }


                function scrollIntoSelectedElement() {
                    const url = new URL(location.href)
                    const task_id = url.hash.slice(1)
                    if(task_id){
                        const taskElem = document.getElementById(`${task_id}`)
                        if (taskElem) {
                            taskElem.scrollIntoView({ behavior: "smooth" });
                        }
                    }
                }

                function prepare_editor(){
                    const targetElement = document.getElementById('editor')
                    editor = new Editor.EditorView({
                        doc: "\n\n",
                        extensions: [Editor.basicSetup, Editor.markdown(),Editor.EditorView.updateListener.of((v) => {
                            if (v.docChanged) {
                                note_editor_render.value = editor.state.doc.toString()
                            }
                        })],
                        parent: targetElement
                    })
                }

                async function fetch_all_notes(){
                    const res = await fetch("/case/"+cases_info.value.case.id+"/all_notes")
                    let loc = await res.json()
                    all_notes.value = loc["notes"]
                }

                async function active_tab(tab_name){
                    if(tab_name == 'main'){
                        main_tab.value = 'main'
                        if ( !document.getElementById("tab-main").classList.contains("active") ){
                            document.getElementById("tab-main").classList.add("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-case").classList.remove("active")
                            document.getElementById("tab-all").classList.remove("active")
                            document.getElementById("tab-hedgedoc").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                            await nextTick()

                            initialize_select2()
                        }
                    }else if(tab_name == 'history'){
                        main_tab.value = 'history'
                        if ( !document.getElementById("tab-history").classList.contains("active") ){
                            document.getElementById("tab-history").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-case").classList.remove("active")
                            document.getElementById("tab-all").classList.remove("active")
                            document.getElementById("tab-hedgedoc").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                        }
                    }else if(tab_name == 'case'){
                        let loc_tab = main_tab.value 
                        main_tab.value = 'case'
                        if ( !document.getElementById("tab-case").classList.contains("active") ){
                            document.getElementById("tab-case").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-all").classList.remove("active")
                            document.getElementById("tab-hedgedoc").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                        }
                        await nextTick()
                        if(!cases_info.value.case.notes && loc_tab != 'case'){
                            prepare_editor()
                        }else{
                            md.mermaid.init()
                            const targetElement = document.getElementById('editor')
                            editor = new Editor.EditorView({
                                doc: cases_info.value.case.notes,
                                extensions: [Editor.basicSetup, Editor.markdown(),Editor.EditorView.updateListener.of((v) => {
                                    if (v.docChanged) {
                                        note_editor_render.value = editor.state.doc.toString()
                                    }
                                })],
                                parent: targetElement
                            })
                        }
                    }else if(tab_name == 'all'){
                        main_tab.value = 'all'
                        if ( !document.getElementById("tab-all").classList.contains("active") ){
                            document.getElementById("tab-all").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-case").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-hedgedoc").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                        }
                        await fetch_all_notes()
                        await nextTick()
                        md.mermaid.init()
                    }else if(tab_name == 'hedgedoc'){
                        main_tab.value = 'hedgedoc'
                        if ( !document.getElementById("tab-hedgedoc").classList.contains("active") ){
                            document.getElementById("tab-hedgedoc").classList.add("active")
                            document.getElementById("tab-all").classList.remove("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-case").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-info").classList.remove("active")
                        }
                        await fetch_all_notes()
                        await nextTick()
                        md.mermaid.init()
                    }else if(tab_name == 'info'){
                        main_tab.value = 'info'
                        if ( !document.getElementById("tab-info").classList.contains("active") ){
                            document.getElementById("tab-info").classList.add("active")
                            document.getElementById("tab-all").classList.remove("active")
                            document.getElementById("tab-main").classList.remove("active")
                            document.getElementById("tab-case").classList.remove("active")
                            document.getElementById("tab-history").classList.remove("active")
                            document.getElementById("tab-hedgedoc").classList.remove("active")
                        }
                        await fetch_all_notes()
                        await nextTick()
                        md.mermaid.init()
                    }
                }


                async function fetch_taxonomies(){
                    const res = await fetch("/case/get_taxonomies")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        taxonomies.value = loc["taxonomies"]
                    }
                }
                fetch_taxonomies()

                async function fetch_galaxies(){
                    const res = await fetch("/case/get_galaxies")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        galaxies.value = loc["galaxies"]
                    }
                }
                fetch_galaxies()

                async function fetch_tags(){
                    const res = await fetch("/case/get_tags?taxonomies=" + JSON.stringify(selected_taxo.value))
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        tags_list.value = loc["tags"]
                        $('#tags_select').trigger('change');
                    }
                }
                async function fetch_cluster(){
                    const res = await fetch("/case/get_clusters?galaxies=" + JSON.stringify(selected_galaxies.value))
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        cluster_list.value = loc["clusters"]
                        $('#clusters_select').trigger('change');
                    }
                }

                async function fetch_custom_tags(){
                    const res = await fetch("/custom_tags/list")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        custom_tags.value = loc
                    }                    
                }
                fetch_custom_tags()

                async function save_note_case(){
                    let notes_loc = editor.state.doc.toString()
                    if(notes_loc.trim().length == 0){
                        notes_loc = notes_loc.trim()
                    }
                    const res_msg = await fetch(
                        '/case/' + cases_info.value.case.id + '/modif_note_case',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"notes": notes_loc})
                        }
                    )
                    if(await res_msg.status == 200){
                        edit_mode.value = false
                        cases_info.value.case.last_modif = Date.now()
                        cases_info.value.case.notes = notes_loc
                        // notes.value = notes_loc
                        await nextTick()
                        
                        if(!notes_loc){
                            const targetElement = document.getElementById('editor')
                            if(targetElement.innerHTML === ""){
                                editor = new Editor.EditorView({
                                    doc: "\n\n",
                                    extensions: [Editor.basicSetup, Editor.markdown(),Editor.EditorView.updateListener.of((v) => {
                                        if (v.docChanged) {
                                            note_editor_render.value = editor.state.doc.toString()
                                        }
                                    })],
                                    parent: targetElement
                                })
                            }
                            
                        }
                        md.mermaid.init()
                    }
                    await display_toast(res_msg)
                }

                async function edit_note(){
                    // Edit the note of the task
                    edit_mode.value = true
                    await nextTick()
                    
                    note_editor_render.value = cases_info.value.case.notes
                    md.mermaid.init()
                    // Initialize the editor
                    const targetElement = document.getElementById('editor')
                    editor = new Editor.EditorView({
                        doc: cases_info.value.case.notes,
                        extensions: [Editor.basicSetup, Editor.markdown(),Editor.EditorView.updateListener.of((v) => {
                            if (v.docChanged) {
                                note_editor_render.value = editor.state.doc.toString()
                            }
                        })],
                        parent: targetElement
                    })
                    
                }

                function initialize_select2(){
                    $('.select2-select').select2({
                        theme: 'bootstrap-5',
                        width: '50%',
                        closeOnSelect: false
                    })


                    $('#taxonomies_select').on('change', function (e) {
                        selected_taxo.value = $(this).select2('data').map(item => item.id);
                        fetch_tags()
                    })

                    $('#tags_select').on('change', function (e) {
                        selected_tags.value = $(this).select2('data').map(item => item.id);
                        fetch_sorted_tasks()
                    })
                    $('#galaxies_select').on('change', function (e) {
                        selected_galaxies.value = $(this).select2('data').map(item => item.id);
                        fetch_cluster()
                    })
                    $('#clusters_select').on('change', function (e) {
                        selected_clusters.value = $(this).select2('data').map(item => item.id);
                        fetch_sorted_tasks()
                    })

                    $('#task_custom_tags_select').on('schange', function (e) {
                        selected_custom_tags.value = $(this).select2('data').map(item => item.id);
                        fetch_sorted_tasks()
                    })
                }

                async function autosave_case_note(){
                    if (edit_mode.value){
                        let notes_loc = editor.state.doc.toString()
                        if(notes_loc.trim().length == 0){
                            notes_loc = notes_loc.trim()
                        }
                        const res_msg = await fetch(
                            '/case/' + cases_info.value.case.id + '/modif_note_case',{
                                headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                method: "POST",
                                body: JSON.stringify({"notes": notes_loc})
                            }
                        )
                        if(await res_msg.status == 200){
                            cases_info.value.case.notes = notes_loc
                        }
                    }
                    setTimeout(autosave_case_note, 30000);
                }

                async function submit_add_new_link() {    
                    $("#add_new_link_error").text("")
                    if($(".new-link-ajax").val().includes("None") || !$(".new-link-ajax").val().length){
                        $("#add_new_link_error").text("Give me more")
                    }else{
                        const res = await fetch('/case/' + cases_info.value.case.id + '/add_new_link',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"case_id": $(".new-link-ajax").val()})
                        })
                        if(await res.status == 200){
                            let loc = $(".new-link-ajax").val()
                            for(let index in loc){
                                for(let i in case_for_link.value){
                                    if(case_for_link.value[i].id == loc[index]){
                                        cases_info.value.case.link_to.push({"id":case_for_link.value[i].id, "title": case_for_link.value[i].text})
                                    }
                                }
                            }
                            var myModalEl = document.getElementById('add_new_link');
                            var modal = bootstrap.Modal.getInstance(myModalEl)
                            modal.hide();
                        }
                        display_toast(res)
                    }
                }

                async function remove_case_link(cases_info, case_loc){
                    const res = await fetch('/case/' + cases_info.case.id + '/remove_case_link/' + case_loc.id)
                    if (await res.status == 200){
                        let index = cases_info.case.link_to.indexOf(case_loc)
                        if(index > -1)
                            cases_info.case.link_to.splice(index, 1)
                    }
                    display_toast(res)
                }

                async function fetch_nb_misp_objects() {
                    const res = await fetch('/case/{{case.id}}/nb_objects')
                    if (await res.status == 200){
                        let loc = await res.json()
                        nb_misp_objects.value = loc["nb_objects"]
                    }
                }

                onMounted(() => {
                    initialize_select2()
                    autosave_case_note()
                    fetch_case_connectors()

                    const list = [].slice.call(
                        document.querySelectorAll('[data-bs-toggle="popover"]'))
                        list.map((el) => {
                            let opts = {
                                animation: false,
                            }
                            if (el.hasAttribute('data-bs-content-id')) {
                                opts.content = document.getElementById(el.getAttribute('data-bs-content-id')).innerHTML;
                                opts.html = true;
                            }
                            new bootstrap.Popover(el, opts);
                        }
                    )

                    $('.new-link-ajax').select2({
                        ajax: {
                            url: '/case/search',
                            data: function (params) {
                                var query = {
                                    text: params.term
                                }
                                submit_add_new_link
                                // Query parameters will be ?text=[term]
                                return query;
                            },
                            processResults: function (data) {
                                case_for_link.value = []
                                for(let i in data.cases){
                                    case_for_link.value.push({id: data.cases[i].id, text: data.cases[i].title})
                                }
                                
                                return {
                                    results: case_for_link.value
                                };
                            }
                        },
                        minimumInputLength: 1,
                        width: "50%",
                        dropdownParent: $('#add_new_link')
                    });

                    $("#id-nb-misp-object").removeClass("d-none")
                    // $("#id-case-status").removeClass("d-none")
                })
                
    
                return {
                    cases_info,
                    status_info,
                    users_in_case,
                    message_list,
                    dayjs,
                    main_tab,
                    history,
                    is_exporting,
                    nb_misp_objects,
                    onInput,
                    sort_by_filter,
                    active_tab,
                    submit_add_new_link,
                    remove_case_link,
                    getTextColor,
                    mapIcon,
                    taxonomies,
                    tags_list,
                    galaxies,
                    cluster_list,
                    custom_tags,
                    open_closed,
                    md,
                    all_notes,
                    note_editor_render,
                    edit_mode,
                    case_connectors_list,
                    all_connectors_list,
                    modules,
                    task_modules,
                    save_note_case,
                    edit_note,
                    export_notes,
                    fetch_case_connectors,

                    change_status_sort,
                    change_switch_check,
                    fetch_sorted_tasks,

                    fetch_nb_misp_objects
                }
            }
        }).mount('#main-container')

    </script>
{% endblock %}