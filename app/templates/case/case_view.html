<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block content %}
    
    <div id="container">
        <div>
            <!-- <div> -->
                <h1 style="display: inline-block; font-size: xxx-large;">{{case.id}} - {{case.title}}</h1>
                <span><i style="font-size: 12px;">{{case.uuid}}</i></span>
                <small v-if="status_info" style="margin-left: 10px;">
                    <span :class="'badge rounded-pill text-bg-'+status_info.status[{{case.status_id}} -1].bootstrap_style">[[ status_info.status[ {{case.status_id}} -1].name ]]</span>
                </small>

            <!-- </div> -->
            <div v-if="cases_info && !cases_info.permission.read_only && cases_info.present_in_case" style="float:right">
                <button class="btn btn-success btn-sm"  @click="complete_case(cases_info.case)"><i class="fa-solid fa-check"></i></button>
                <a class="btn btn-primary btn-sm" :href="`/case/edit/${cases_info.case.id}`" type="button"><i class="fa-solid fa-pen-to-square"></i></a>
                <button class="btn btn-danger btn-sm"  @click="delete_case(cases_info.case.id)"><i class="fa-solid fa-trash"></i></button>
            </div>

            
            <div>
                <br/>
                Creation: {{case.creation_date}}
                <br/>
                Last Modif: {{case.last_modif}}
                {% if case.dead_line %}
                    <br/>
                    Dead Line: {{case.dead_line}}
                {%endif%}

                <div id="assign" style="float: right;" v-if="cases_info">
                    <div class="dropdown" id="dropdown_user_case">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Orgs</button>
                        <ul class="dropdown-menu">
                            <template v-if="!cases_info.permission.read_only && cases_info.present_in_case">
                                <li>
                                    <a class="btn btn-primary" :href="`/case/view/${cases_info.case.id}/add_orgs`" role="button">Add Orgs</a>
                                </li>
                            </template>
                            <template v-for="org in cases_info.orgs_in_case">
                                <li>
                                    <div style="display: flex;">
                                        <button class="dropdown-item">[[org.name]]</button>
                                        <button class="btn btn-danger" @click="remove_org_case(cases_info, org)">Delete</button>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        {% if case.description %}
        <div>
            <hr>
            <p style="display: inline-block;">{{case.description}}</p>
        </div>
        {%endif%}
        
        <hr style="margin-bottom: 40px;">

        <div style="display: flex;">
            <h3>Tasks</h3>
            {% if not current_user.read_only() and present_in_case %}
                <span style="padding-left: 10px;">
                    <a class="btn btn-primary btn-small" href="/case/{{id}}/add_task"><i class="fa-solid fa-plus"></i></a>
                </span>
            {%endif%}
        </div>




        <template v-if="cases_info && cases_info.tasks && status_info" >
            <template v-for="task in cases_info.tasks" :key="task.id">

                <div class="list-group" style="margin-bottom: 20px;" v-if="!task.completed">
                    <div style="display: flex;">                          
                        <a :href="'#collapse'+task.id" class="list-group-item list-group-item-action" data-bs-toggle="collapse" role="button" aria-expanded="false" :aria-controls="'collapse'+task.id">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">[[task.title]]</h5>
                                <small><i>Changed [[ moment(task.last_modif).fromNow() ]]</i></small>
                            </div>

                            <div class="d-flex w-100 justify-content-between">
                                <p v-if="task.description" class="card-text">[[ task.description ]]</p>
                                <p v-else class="card-text"><i style="font-size: 12px;">No description</i></p>
        
                                <small v-if="status_info"><span :class="'badge rounded-pill text-bg-'+status_info.status[task.status_id -1].bootstrap_style">[[ status_info.status[task.status_id -1].name ]]</span></small>
                            </div>

                            <div v-if="task.users.length">
                                Users: 
                                <template v-for="user in task.users">
                                    [[user.first_name]] [[user.last_name]],
                                </template>
                            </div>

                            <div v-else>
                                <i>No user assigned</i>
                            </div>
                        </a>
                        <div v-if="!cases_info.permission.read_only && cases_info.present_in_case" style="display: grid;">
                            <button class="btn btn-success btn-sm"  @click="complete_task(task)"><i class="fa-solid fa-check"></i></button>
                            <button v-if="!task.is_current_user_assigned" class="btn btn-secondary btn-sm"  @click="take_task(task, cases_info.current_user)"><i class="fa-solid fa-hand"></i></button>
                            <button v-else class="btn btn-secondary btn-sm"  @click="remove_assign_task(task, cases_info.current_user)"><i class="fa-solid fa-handshake-slash"></i></button>
                            <a class="btn btn-primary btn-sm" :href="'/case/view/'+cases_info.case.id+'/edit_task/'+task.id" type="button"><i class="fa-solid fa-pen-to-square"></i></a>
                            <button class="btn btn-danger btn-sm"  @click="delete_task(task, cases_info.tasks)"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>

                    
                    <!-- Collapse Part -->
                    <div class="collapse" :id="'collapse'+task.id">
                        <div class="card card-body" style="background-color: whitesmoke;">
                            <div class="d-flex w-100 justify-content-between">
                                <div>
                                    <div>
                                        <h3>Notes</h3>
                                    </div>
                                    <div v-if="task.notes">
                                        <template v-if="edit_mode">
                                            <div>
                                                <button class="btn btn-primary" @click="modif_note(task)" type="button" :id="'note_'+task.id">
                                                    <div hidden>[[task.title]]</div>
                                                    Save
                                                </button>
                                            </div>
                                            <textarea :ref="'ref_note_'+task.id" :id="'note_area_'+task.id" rows="5" cols="30" maxlength="5000" v-html="task.notes"></textarea>
                                        </template>
                                        <template v-else>
                                            <template v-if="!cases_info.permission.read_only && cases_info.present_in_case">
                                                <button class="btn btn-primary" @click="edit_note(task)" type="button" :id="'note_'+task.id">
                                                    <div hidden>[[task.title]]</div>
                                                    Edit
                                                </button>
                                            </template> 
                                            <p v-html="task.notes"></p>
                                        </template>
                                    </div>
                                    <div v-else>
                                        <template v-if="!cases_info.permission.read_only && cases_info.present_in_case">
                                            <div>
                                                <button class="btn btn-primary" @click="modif_note(task)" type="button" :id="'note_'+task.id">
                                                    <div hidden>[[task.title]]</div>
                                                    Create
                                                </button>
                                            </div>
                                            <textarea :ref="'ref_note_'+task.id" :id="'note_area_'+task.id" rows="5" cols="30" maxlength="5000"></textarea>
                                        </template>
                                    </div>
                                </div>

                                <div>
                                    <div>
                                        <h3>Files</h3>
                                    </div>
                                    <div>
                                        <div>
                                            <input class="form-control" type="file" :id="'formFileMultiple'+task.id" multiple/>
                                            <button class="btn btn-primary" @click="add_file(task)">Add</button>
                                        </div>
                                        <br/>
                                        <template v-if="task.files.length">
                                            <template v-for="file in task.files">
                                                <div>
                                                    <a class="btn btn-link" :href="`/case/task/${task.id}/download_file/${file.id}`">
                                                        [[ file.name.split(")")[1] ]]
                                                    </a>
                                                    <button class="btn btn-danger" @click="delete_file(file, task)"><i class="fa-solid fa-trash"></i></button>
                                                </div>
                                            </template>
                                        </template>
                                    </div>
                                </div>
                                <div>
                                    <div>
                                        <h3>Change Status</h3>
                                    </div>
                                    <div>
                                        <div class="dropdown" :id="'dropdown_status_'+task.id">
                                            <template v-if="status_info">
                                                <button class="btn btn-secondary dropdown-toggle" :id="'button_'+task.id" type="button" data-bs-toggle="dropdown" aria-expanded="false">[[ status_info.status[task.status_id -1].name ]]</button>
                                                <ul class="dropdown-menu" :id="'dropdown_ul_status_'+task.id">
                                                    <template v-for="status_list in status_info.status">
                                                        <li v-if="status_list.id != task.status_id">
                                                            <button class="dropdown-item" @click="change_status(status_list.id, task)">[[ status_list.name ]]</button>
                                                        </li>
                                                    </template>
                                                </ul>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </template>

            <div class="list-group" style="margin-bottom: 20px; margin-top: 50px;" >
                <a href="#collapse_close_task" class="list-group-item list-group-item-action" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="collapse_close_task">
                    <hr>
                </a>
            </div>

            <div class="collapse" id="collapse_close_task">
                <div class="card card-body" style="background-color: #fbfbfb; border:#fbfbfb">
                    <template v-for="task in cases_info.tasks" :key="task.id">
                        <div class="list-group" style="margin-bottom: 20px;" v-if="task.completed">
                            <div style="display: flex;">                          
                                <a :href="'#collapse'+task.id" class="list-group-item list-group-item-action" data-bs-toggle="collapse" role="button" aria-expanded="false" :aria-controls="'collapse'+task.id">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">[[task.title]]</h5>
                                        <small><i>Changed [[ moment(task.last_modif).fromNow() ]]</i></small>
                                    </div>

                                    <div class="d-flex w-100 justify-content-between">
                                        <p v-if="task.description" class="card-text">[[ task.description ]]</p>
                                        <p v-else class="card-text"><i style="font-size: 12px;">No description</i></p>
                
                                        <small v-if="status_info"><span :class="'badge rounded-pill text-bg-'+status_info.status[task.status_id -1].bootstrap_style">[[ status_info.status[task.status_id -1].name ]]</span></small>
                                    </div>

                                    <div v-if="task.users.length">
                                        Users: 
                                        <template v-for="user in task.users">
                                            [[user.first_name]] [[user.last_name]],
                                        </template>
                                    </div>

                                    <div v-else>
                                        <i>No user assigned</i>
                                    </div>
                                </a>
                                <div v-if="!cases_info.permission.read_only && cases_info.present_in_case" style="display: grid;">
                                    <button class="btn btn-success btn-sm"  @click="complete_task(task)"><i class="fa-solid fa-check"></i></button>
                                    <button v-if="!task.is_current_user_assigned" class="btn btn-secondary btn-sm"  @click="take_task(task, cases_info.current_user)"><i class="fa-solid fa-hand"></i></button>
                                    <button v-else class="btn btn-secondary btn-sm"  @click="remove_assign_task(task, cases_info.current_user)"><i class="fa-solid fa-handshake-slash"></i></button>
                                    <a class="btn btn-primary btn-sm" :href="'/case/view/'+cases_info.case.id+'/edit_task/'+task.id" type="button"><i class="fa-solid fa-pen-to-square"></i></a>
                                    <button class="btn btn-danger btn-sm"  @click="delete_task(task, cases_info.tasks)"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>

                            
                            <!-- Collapse Part -->
                            <div class="collapse" :id="'collapse'+task.id">
                                <div class="card card-body" style="background-color: whitesmoke;">
                                    <div class="d-flex w-100 justify-content-between">
                                        <div>
                                            <div>
                                                <h3>Notes</h3>
                                            </div>
                                            <div v-if="task.notes">
                                                <template v-if="edit_mode">
                                                    <div>
                                                        <button class="btn btn-primary" @click="modif_note(task)" type="button" :id="'note_'+task.id">
                                                            <div hidden>[[task.title]]</div>
                                                            Save
                                                        </button>
                                                    </div>
                                                    <textarea :ref="'ref_note_'+task.id" :id="'note_area_'+task.id" rows="5" cols="30" maxlength="5000" v-html="task.notes"></textarea>
                                                </template>
                                                <template v-else>
                                                    <template v-if="!cases_info.permission.read_only && cases_info.present_in_case">
                                                        <button class="btn btn-primary" @click="edit_note(task)" type="button" :id="'note_'+task.id">
                                                            <div hidden>[[task.title]]</div>
                                                            Edit
                                                        </button>
                                                    </template> 
                                                    <p v-html="task.notes"></p>
                                                </template>
                                            </div>
                                            <div v-else>
                                                <template v-if="!cases_info.permission.read_only && cases_info.present_in_case">
                                                    <div>
                                                        <button class="btn btn-primary" @click="modif_note(task)" type="button" :id="'note_'+task.id">
                                                            <div hidden>[[task.title]]</div>
                                                            Create
                                                        </button>
                                                    </div>
                                                    <textarea :ref="'ref_note_'+task.id" :id="'note_area_'+task.id" rows="5" cols="30" maxlength="5000"></textarea>
                                                </template>
                                            </div>
                                        </div>

                                        <div>
                                            <div>
                                                <h3>Files</h3>
                                            </div>
                                            <div>
                                                <div>
                                                    <input class="form-control" type="file" :id="'formFileMultiple'+task.id" multiple/>
                                                    <button class="btn btn-primary" @click="add_file(task)">Add</button>
                                                </div>
                                                <br/>
                                                <template v-if="task.files.length">
                                                    <template v-for="file in task.files">
                                                        <div>
                                                            <a class="btn btn-link" :href="`/case/task/${task.id}/download_file/${file.id}`">
                                                                [[ file.name.split(")")[1] ]]
                                                            </a>
                                                            <button class="btn btn-danger" @click="delete_file(file, task)"><i class="fa-solid fa-trash"></i></button>
                                                        </div>
                                                    </template>
                                                </template>
                                            </div>
                                        </div>
                                        <div>
                                            <div>
                                                <h3>Change Status</h3>
                                            </div>
                                            <div>
                                                <div class="dropdown" :id="'dropdown_status_'+task.id">
                                                    <template v-if="status_info">
                                                        <button class="btn btn-secondary dropdown-toggle" :id="'button_'+task.id" type="button" data-bs-toggle="dropdown" aria-expanded="false">[[ status_info.status[task.status_id -1].name ]]</button>
                                                        <ul class="dropdown-menu" :id="'dropdown_ul_status_'+task.id">
                                                            <template v-for="status_list in status_info.status">
                                                                <li v-if="status_list.id != task.status_id">
                                                                    <button class="dropdown-item" @click="change_status(status_list.id, task)">[[ status_list.name ]]</button>
                                                                </li>
                                                            </template>
                                                        </ul>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <!-- <case_view :msg="msg_child" :cases_info="cases_info" ></case_view> -->
        </template>

    </div>
  
{% endblock %}

{% block script %}
	<!-- <script src="{{ url_for('static',filename='js/case/case_view.js') }}"></script> -->

    <script type="module">
        const { createApp, ref, computed, onMounted } = Vue
        import case_view from '../../static/js/case/case_view.js'
        
        createApp({
            delimiters: ['[[', ']]'],
            components: {
                case_view
            },
            setup() {
                const edit_mode = ref(false)
                const cases_info = ref(null)
                const status_info = ref(null)
                const msg_child = ref("hello")

                async function fetchCase() {
                    cases_info.value = null
                    const res = await fetch(
                        'get_case_info/'+window.location.pathname.split("/").slice(-1)
                    )
                    cases_info.value = await res.json()
                }

                async function fetchStatus() {
                    status_info.value = null
                    const res = await fetch(
                        '/case/get_status'
                    )
                    status_info.value = await res.json()
                }

                async function delete_case(case_id){
                    await fetch(
                        '/case/delete',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"case_id": case_id.toString()})
                        }
                    )

                    return window.location.href="/case"
                }

                function change_status(status, task){

                    task.last_modif = Date.now()
                    task.status_id=status
                    fetch(
                        '/case/change_status/'+task.id,{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"status": status})
                        }
                    )
                        
                    if(status_info.value.status[status-1].name == 'Finished'){
                        task.last_modif = Date.now()
                        task.completed = true
                        fetch('/case/complete_task/'+task.id)
                    }else{
                        task.completed = false
                    }
                }

                function take_task(task, current_user){
                    task.last_modif = Date.now()
                    task.is_current_user_assigned = true
                    task.users.push(current_user)
                    
                    fetch(
                        '/case/take_task',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"task_id": task.id.toString()})
                        }
                    )
                }

                function remove_assign_task(task, current_user){
                    task.last_modif = Date.now()
                    task.is_current_user_assigned = false

                    let index = -1

                    for(let i=0;i<task.users.length;i++){
                        if (task.users[i].id==current_user.id)
                            index = i
                    }

                    if(index > -1)
                        task.users.splice(index, 1)
                
                    
                    fetch(
                        '/case/remove_assign_task',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"task_id": task.id.toString()})
                        }
                    )
                }

                function delete_task(task, task_array){
                    fetch(
                        '/case/delete_task',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"task_id": task.id.toString()})
                        }
                    )

                    let index = task_array.indexOf(task)
                    if(index > -1)
                        task_array.splice(index, 1)
                }

                async function edit_note(task){
                    task.last_modif = Date.now()
                    edit_mode.value = true
                    const res = await fetch('/case/get_note_text?id='+task.id)
                    let loc = await res.json()

                    task.notes = loc["note"]
                }

                async function modif_note(task){
                    task.last_modif = Date.now()
                    edit_mode.value = false
                    let notes = this.$refs["ref_note_" + task.id][0].value
                    task.notes = notes

                    await fetch(
                        '/case/modif_note',{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"task_id": task.id.toString(), "notes": notes})
                        }
                    )

                    const res = await fetch('/case/get_note_markdown?id='+task.id)
                    let loc = await res.json()

                    task.notes = loc["note"]
                }


                function remove_org_case(cases_info, org){
                    fetch('/case/' + cases_info.case.id + '/remove_org/' + org.id)

                    let index = cases_info.orgs_in_case.indexOf(org)
                    if(index > -1)
                        cases_info.orgs_in_case.splice(index, 1)
                }


                async function add_file(task){
                    task.last_modif = Date.now()
                    let files = document.getElementById('formFileMultiple'+task.id).files

                    let formData = new FormData();
                    for(let i=0;i<files.length;i++){
                        formData.append("files"+i, files[i]);
                    }
                    formData.append("task_id", task.id.toString());

                    const res = await fetch(
                        '/case/add_files',{
                            headers: { "X-CSRFToken": $("#csrf_token").val() },
                            method: "POST",
                            files: files,
                            body: formData
                        }
                    )
                    
                    let loc = await res.json()

                    for(let file in loc){
                        task.files.push(loc[file])
                    }

                }

                function delete_file(file, task){
                    task.last_modif = Date.now()
                    fetch('/case/task/' + task.id + '/delete_file/' + file.id)

                    let index = task.files.indexOf(file)
                    if(index > -1)
                    task.files.splice(index, 1)
                }

                function complete_case(case_loc){
                    case_loc.completed = true
                    fetch('/case/complete_case/'+case_loc.id) 
                }

                function complete_task(task){
                    task.last_modif = Date.now()
                    task.completed = !task.completed
                    let status = task.status_id
                    fetch('/case/complete_task/'+task.id)

                    if(status_info.value.status[task.status_id -1].name == 'Finished'){
                        for(let i in status_info.value.status){
                            if(status_info.value.status[i].name == 'Revive')
                                task.status_id = status_info.value.status[i].id
                        }
                        if(task.status_id == status)
                            task.status_id = 1

                        fetch('/case/change_status/'+task.id,{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"status": task.status_id})
                        })
                    }else{
                        for(let i in status_info.value.status){
                            if(status_info.value.status[i].name == 'Finished'){
                                task.status_id = status_info.value.status[i].id
                                fetch('/case/change_status/'+task.id,{
                                    headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                    method: "POST",
                                    body: JSON.stringify({"status": task.status_id})
                                })
                                break
                            }
                        }
                        
                    }
                }
                

                fetchCase()
                fetchStatus()
    
                return {
                    cases_info,
                    status_info,
                    edit_mode,
                    msg_child,
                    moment,
                    delete_case,
                    change_status,
                    take_task,
                    remove_assign_task,
                    delete_task,
                    edit_note,
                    modif_note,
                    remove_org_case,
                    add_file,
                    delete_file,
                    complete_case,
                    complete_task
                }
            }
        }).mount('#container')

    </script>
{% endblock %}