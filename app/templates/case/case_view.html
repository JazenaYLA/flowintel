<!-- 
    Author: David Cruciani
-->

{% extends 'base.html' %}

{% block content %}
    <div id="top"></div>
    <h1 style="display: inline-block; font-size: xxx-large;"><a type="button" class="btn" href="/case"><i class="fa-solid fa-arrow-left"></i></a></h1>

    <h1 style="display: inline-block; font-size: xx-large;">{{case.id}}- {{case.title}}</h1>
    <span><i style="font-size: 12px;">{{case.uuid}}</i></span>
    <small v-if="status_info" style="margin-left: 10px;">
        <span :class="'badge rounded-pill text-bg-'+status_info.status[{{case.status_id}} -1].bootstrap_style">[[ status_info.status[ {{case.status_id}} -1].name ]]</span>
    </small>

    <div v-if="cases_info && (!cases_info.permission.read_only && cases_info.present_in_case || cases_info.permission.admin)" style="float:right; display: grid;">
        <a class="btn btn-primary btn-sm"  :href="`/case/${cases_info.case.id}/download`" type="button" title="Download the case in json"><i class="fa-solid fa-download"></i></a>
        <button class="btn btn-danger btn-sm"  @click="delete_case(cases_info.case.id)" title="Delete the Case"><i class="fa-solid fa-trash"></i></button>
    </div>
    <div v-if="cases_info && (!cases_info.permission.read_only && cases_info.present_in_case || cases_info.permission.admin)" style="float:right">
        <button v-if="cases_info.case.completed" class="btn btn-secondary btn-sm"  @click="complete_case(cases_info.case)" title="Complete the case"><i class="fa-solid fa-backward"></i></button>
        <button v-else class="btn btn-success btn-sm"  @click="complete_case(cases_info.case)" title="Complete the case"><i class="fa-solid fa-check"></i></button>
        <a class="btn btn-primary btn-sm" :href="`/case/edit/${cases_info.case.id}`" type="button" title="Edit the case"><i class="fa-solid fa-pen-to-square"></i></a>
        <a class="btn btn-secondary btn-sm"  :href="`/case/${cases_info.case.id}/recurring`" type="button" title="Recurring Case"><i class="fa-solid fa-clock"></i></a>

        <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="dropdown" aria-expanded="false" title="Fork the case">
            <i class="fa-solid fa-code-fork"></i>
        </button>
        <ul class="dropdown-menu">
            <li>
                <input id="case_title_fork" placeholder="Case title"/>
                <button class="btn btn-primary btn-sm" @click="fork_case(cases_info.case.id)">Fork</button>
            </li>
        </ul>

        <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="dropdown" aria-expanded="false" title="Create a template from the case">
            <i class="fa-solid fa-bookmark"></i>
        </button>
        <ul class="dropdown-menu">
            <li>
                <input id="case_title_template" placeholder="Case title"/>
                <button class="btn btn-primary btn-sm" @click="create_template(cases_info.case)">Template</button>
            </li>
        </ul>
    </div>
    <br>
    <div class="dropdown" style="float: right;">
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#Send_to_modal">
            Send to
        </button>
        
        <!-- Modal -->
        <div class="modal fade" id="Send_to_modal" tabindex="-1" aria-labelledby="Send_to_modalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="Send_to_modalLabel">Send to modules</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div style="display: flex;">
                            <div>
                                <label for="modules_select">Modules:</label>
                                <select data-placeholder="Modules" class="select2-select form-control" name="modules_select" id="modules_select" >
                                    <option value="None">--</option>
                                    <template v-for="module, key in modules">
                                        <option v-if="module.type == 'send_to' && module.config.case_task == 'case'" :value="[[key]]">[[key]]</option>
                                    </template>
                                </select>
                                <div id="modules_errors" class="invalid-feedback"></div>
                            </div>
                            <div style="min-width: 100%;">
                                <label for="instances_select">Instances:</label>
                                <select data-placeholder="Instances" class="select2-select form-control" multiple name="instances_select" id="instances_select" >
                                    <template v-if="module_selected">
                                        <template v-for="instance, key in module_selected">
                                            <option :value="[[instance.name]]">[[instance.name]]</option>
                                        </template>
                                    </template>
                                </select>
                                <div id="instances_errors" class="invalid-feedback"></div>
                            </div>
                        </div>
                        <div class="row" v-if="instances_selected">
                            <div class="mb-3 w-50" v-for="instance, key in instances_selected" >
                                <label :for="'identifier_' + instance.id">Identifier for <u><i>[[instance.name]]</i></u></label>
                                <input :id="'identifier_' + instance.id" class="form-control" :value="instance.identifier" :name="'identifier_' + instance.id" type="text">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button v-if="module_loader" class="btn btn-primary" type="button" disabled>
                            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                            <span role="status">Loading...</span>
                          </button>
                          <button v-else type="button" @click="submit_module()" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>
  
    </div>

    {% if case.tags %}
        <div style="display: flex;">
            {% for tag in case.tags%}
                <div class="tag" title="{{tag.description}}" :style="{'background-color': '{{tag.color}}', 'color': getTextColor('{{tag.color}}')}">
                    <i class="fa-solid fa-tag" style="margin-right: 3px; margin-left: 3px;"></i>
                    {{tag.name}}
                </div>
            {%endfor%}
        </div>
    {%endif%}

    <div style="margin-top: 5px;">
        {% if case.clusters %}
            {% for cluster in case.clusters %}
                <div title="Description: &#013;{{cluster.description}}&#013;&#013; Metadata: &#013;{{cluster.meta}}">
                    <span v-html="mapIcon('{{cluster.icon}}')"></span>
                    {{cluster.tag}}
                </div>
            {%endfor%}
        {%endif%}
    </div>

    <br>
    {% if case.instances %}
        {% for instance in case.instances %}
            <div title="{{instance.description}}">
                <img src="/static/icons/{{instance.icon}}" style="max-width: 30px;">
                <a style="margin-left: 5px" href="{{instance.url}}">{{instance.url}}</a>
                <span style="margin-left: 3px;" title="identifier used by module">{{instance.identifier}}</span>
            </div>
        {%endfor%}
    {%endif%}

    <div class="d-flex w-100 justify-content-between" v-if="cases_info" style="margin-top: 10px;">
        <i :title="cases_info.case.creation_date">Created: [[ moment.utc( cases_info.case.creation_date ).from(moment.utc()) ]]</i>
        <i :title="cases_info.case.last_modif">Changed: [[ moment.utc( cases_info.case.last_modif ).from(moment.utc()) ]]</i>
        {% if case.deadline %}
            <i :title="cases_info.case.deadline">Deadline: [[ moment.utc( cases_info.case.deadline ).endOf().from(moment.utc()) ]]</i>
        {%endif%}
    </div>
    {%if case.recurring_type %}
        <div class="d-flex w-100 justify-content-between" v-if="cases_info" style="margin-top: 10px;">
            <i>Recurring type: {{case.recurring_type}}</i>
            {%if case.recurring_date %}
                <i :title="cases_info.case.last_modif">Recurring Date: {{case.recurring_date}}</i>
            {%endif%}
        </div>
    {%endif%}

    <div id="assign" style="float: right;" v-if="cases_info">
        <div class="dropdown" id="dropdown_user_case">
            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Orgs</button>
            <ul class="dropdown-menu">
                <template v-if="!cases_info.permission.read_only && cases_info.present_in_case || cases_info.permission.admin">
                    <li>
                        <a class="btn btn-primary" :href="`/case/${cases_info.case.id}/add_orgs`" role="button">Add Orgs</a>
                    </li>
                </template>
                <template v-for="org in cases_info.orgs_in_case" :key="org.id">
                    <li>
                        <div style="display: flex;">
                            <button class="dropdown-item">[[org.name]]</button>
                            <template v-if="org.id != cases_info.case.owner_org_id || cases_info.permission.admin">
                                <button class="btn btn-danger" @click="remove_org_case(cases_info, org)" v-if="!cases_info.permission.read_only && cases_info.present_in_case || cases_info.permission.admin">Delete</button>
                            </template>
                        </div>
                    </li>
                </template>
            </ul>
        </div>
    </div>
    
    {% if case.description %}
    <div>
        <hr>
        <p style="display: inline-block;">{{case.description}}</p>
    </div>
    {%endif%}
    
    <hr style="margin-bottom: 40px;">

    <ul class="nav nav-tabs" style="margin-bottom: 10px;">
        <li class="nav-item">
            <button class="nav-link active" id="tab-main" aria-current="page" @click="active_tab(true)">Main</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="tab-history" @click="active_tab(false)">History</button>
        </li>
    </ul>


    <template v-if="main_tab">
        <div style="display: flex;">
            <h3>Tasks</h3>
            {% if not current_user.read_only() and present_in_case or current_user.is_admin() %}
                <span style="padding-left: 10px;">
                    <a href="/case/{{case.id}}/create_task" class="btn btn-primary"><i class="fa-solid fa-plus"></i></a>
                </span>
            {%endif%}

            <!-- Search bar -->
            <div class="input-group w-auto start-50 translate-middle-x">
                <input autocomplete="off" @input="onInput" type="search" class="form-control rounded" placeholder='Search task by title' style="min-width: 400px;" />
            </div>
            <!-- Search bar -->
        </div>

        <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapsefiltertask" aria-expanded="false" aria-controls="collapsefiltertask">
            filter
        </button>
        <div class="collapse" id="collapsefiltertask">
            <div class="card card-body">
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioStatus" id="radioStatusOngoing" @click="filter_ongoing(true)" checked>
                            <label class="form-check-label" for="radioStatusOngoing">Ongoing Tasks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioStatus" id="radioStatusFinished" @click="filter_ongoing(false)">
                            <label class="form-check-label" for="radioStatusFinished">Finished Tasks</label>
                        </div>
                    </div>

                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherTitle" @click="sort_by_filter('title')" checked>
                            <label class="form-check-label" for="radioOtherTitle">Title</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOrderAsc" @click="sort_by_filter('last_modif')">
                            <label class="form-check-label" for="radioOrderAsc">Last Modif</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherDeadLine" @click="sort_by_filter('deadline')">
                            <label class="form-check-label" for="radioOtherDeadLine">Deadline</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherStatus" @click="sort_by_filter('status_id')">
                            <label class="form-check-label" for="radioOtherStatus">Status</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherAssign" @click="sort_by_filter('assigned_tasks')">
                            <label class="form-check-label" for="radioOtherAssign">Assigned tasks</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="radioOther" id="radioOtherCurrentAssign" @click="sort_by_filter('my_assignment')">
                            <label class="form-check-label" for="radioOtherCurrentAssign">My assignment</label>
                        </div>
                    </div>

                    <div style="display:flex">
                    <span style="margin-right: 10px">Asc</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" @click="asc_desc_filter(true)">
                            <label class="form-check-label" for="flexSwitchCheckDefault">Desc</label>
                        </div>
                
                    </div>
                </div>
                <hr>
                <div>Taxonomies:</div>
                <div class="d-flex w-100 justify-content-center">
                    <div style="display:flex">
                        <span style="margin-right: 10px">OR</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switchOperator" @click="asc_desc_filter(false,true)">
                            <label class="form-check-label" for="switchOperator">AND</label>
                        </div>
                    </div>
                </div>
                <div style="display: flex;">
                    <template v-if="taxonomies">
                        <select data-placeholder="Taxonomies" class="select2-select form-control" multiple name="taxonomies_select" id="taxonomies_select" >
                            <template v-for="taxonomy, key in taxonomies">
                                <option :value="[[taxonomy.name]]">[[taxonomy.name]]</option>
                            </template>
                        </select>
                    </template>
                    
                    <template v-if="tags_list">
                        <select data-placeholder="Tags" class="select2-select form-control" multiple name="tags_select" id="tags_select" >
                            <template v-for="(tags, taxo) in tags_list">
                                <optgroup :label="[[taxo]]">
                                    <option :value="[[tag.name]]" v-for="tag in tags">[[tag.name]]</option>
                                </optgroup>
                            </template>
                        </select>
                    </template>
                </div>
                <hr>

                <div>Galaxies:</div>
                <div class="d-flex w-100 justify-content-center">
                    <div style="display:flex">
                        <span style="margin-right: 10px">OR</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switchOperator" @click="asc_desc_filter(false, false, true)">
                            <label class="form-check-label" for="switchOperator">AND</label>
                        </div>
                    </div>
                </div>
                <div style="display: flex;">
                    <template v-if="galaxies">
                        <select data-placeholder="Galaxies" class="select2-select form-control" multiple name="galaxies_select" id="galaxies_select" >
                            <template v-for="galaxy, key in galaxies">
                                <option :value="[[galaxy.name]]">[[galaxy.name]]</option>
                            </template>
                        </select>
                    </template>
                    
                    <template v-if="cluster_list">
                        <select data-placeholder="Cluster" class="select2-select form-control" multiple name="clusters_select" id="clusters_select" >
                            <template v-for="(clusters, galaxy) in cluster_list">
                                <optgroup :label="[[galaxy]]">
                                    <option :value="[[cluster.name]]" :title="cluster.description" v-for="cluster in clusters">[[cluster.tag]]</option>
                                </optgroup>
                            </template>
                        </select>
                    </template>
                </div>
            </div>
        </div>

        <hr>

        <template v-if="cases_info && cases_info.tasks && status_info" >
            <template v-for="task, key in cases_info.tasks" :key="task.id">
                <div :id="`task-${task.id}`"  class="list-group" style="margin-bottom: 20px;">
                    <case_tasks :cases_info="cases_info" :users_in_case="users_in_case" :status_info="status_info" :edit_mode="edit_mode" :task="task" :key_loop="key" @edit_mode="(msg) => edit_mode = msg" @task="(msg) => task = msg"></case_tasks>
                </div>
            </template>
        </template>
        <template v-else>
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </template>
    </template>




    <template v-else>
        <template v-if="history">
            <div v-for="h in history">
                [[h]]
            </div>
        </template>
        <template v-else>
            <i>No history</i>
        </template>
    </template>
    
    <span id="goTop">[<a href="#top">Go Back Top</a>]</span>
{% endblock %}




{% block script %}
    <script type="module">
        const { createApp, ref, computed, nextTick, onMounted } = Vue
        import case_tasks from '/static/js/case/case_tasks.js'
        import {display_toast, message_list} from '/static/js/toaster.js'
        
        createApp({
            delimiters: ['[[', ']]'],
            components: {
                case_tasks
            },
            setup() {
                const edit_mode = ref(false)
                const cases_info = ref(null)
                const status_info = ref(null)
                const users_in_case = ref(null)
                let loc_tasks_list = []

                let show_ongoing = true
                let current_filter = ""
                let asc_desc = true
                let or_and_taxo = true
                let or_and_galaxies = true

                const main_tab = ref(true)
                const history = ref(null)

                const taxonomies = ref([])
                const tags_list = ref([])
                const selected_taxo = ref([])
                const selected_tags = ref([])

                const galaxies = ref([])
                const cluster_list = ref([])
                const selected_galaxies = ref([])
                const selected_clusters = ref([])

                const modules = ref()
                const module_selected = ref()
                const instances_selected = ref([])
                const module_loader = ref(false)

                async function fetch_history(){
                    const res = await fetch("/case/history/" + cases_info.value.case.id)
                    if(await res.status==404 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        history.value = loc["history"]
                    }
                }

                async function filter_ongoing(ongoing){
                    show_ongoing = ongoing

                    let loc
                    let tags = ""
                    let taxo = ""
                    let galax = ""
                    let clusters = ""
                    if(selected_tags.value.length) tags = "&tags=" + JSON.stringify(selected_tags.value)
                    if(selected_taxo.value.length) taxo = "&taxonomies=" + JSON.stringify(selected_taxo.value)
                    if(selected_galaxies.value.length) galax = "&galaxies=" + JSON.stringify(selected_galaxies.value)
                    if(selected_clusters.value.length) clusters = "&clusters=" + JSON.stringify(selected_clusters.value)

                    if(show_ongoing){
                        const res = await fetch('/case/'+cases_info.value.case.id+'/sort_by_ongoing_task?or_and_taxo=' + or_and_taxo + '&or_and_galaxies=' + or_and_galaxies + tags + taxo + galax + clusters)
                        loc = await res.json()
                    }else{
                        const res = await fetch('/case/'+cases_info.value.case.id+'/sort_by_finished_task?or_and_taxo=' + or_and_taxo + '&or_and_galaxies=' + or_and_galaxies + tags + taxo + galax + clusters)
                        loc = await res.json()
                    }
                    cases_info.value.tasks = loc
                    loc_tasks_list = cases_info.value.tasks
                }

                function sort_by_filter(filter){
                    current_filter = filter
                    asc_desc_filter()
                }

                async function asc_desc_filter(change=false, changeOperator=false, changeOperatorGalaxies=false){
                    if (change) asc_desc = !asc_desc
                    if (changeOperator) or_and_taxo = !or_and_taxo
                    if (changeOperatorGalaxies) or_and_galaxies = !or_and_galaxies

                    let res
                    if (current_filter){
                        let tags = ""
                        let taxo = ""
                        let galax = ""
                        let clusters = ""
                        if(selected_tags.value.length) tags = "&tags=" + JSON.stringify(selected_tags.value)
                        if(selected_taxo.value.length) taxo = "&taxonomies=" + JSON.stringify(selected_taxo.value)
                        if(selected_galaxies.value.length) galax = "&galaxies=" + JSON.stringify(selected_galaxies.value)
                        if(selected_clusters.value.length) clusters = "&clusters=" + JSON.stringify(selected_clusters.value)

                        if(show_ongoing)
                            res = await fetch(`/case/${cases_info.value.case.id}/tasks/ongoing?or_and_taxo=${or_and_taxo}&or_and_galaxies=${or_and_galaxies}&filter=${current_filter}${tags}${taxo}${galax}${clusters}`)
                        else
                            res = await fetch(`/case/${cases_info.value.case.id}/tasks/finished?or_and_taxo=${or_and_taxo}&or_and_galaxies=${or_and_galaxies}&filter=${current_filter}${tags}${taxo}${galax}${clusters}`)
                        let loc = await res.json()
                        if(asc_desc)
                            cases_info.value.tasks = loc.reverse()
                        else
                            cases_info.value.tasks = loc

                        loc_tasks_list = cases_info.value.tasks
                    }else{
                        filter_ongoing(show_ongoing)   
                    }
                }


                async function fetchCase() {
                    cases_info.value = null
                    const res = await fetch(
                        window.location.pathname.split("/").slice(-1)+'/get_case_info'
                    )

                    if(await res.status == 404){
                        display_toast(res)
                    }else{
                        cases_info.value = await res.json()
                        loc_tasks_list = cases_info.value.tasks
                        fetch_history()
                        await nextTick()
                        scrollIntoSelectedElement()
                    }
                }

                async function fetchStatus() {
                    status_info.value = null
                    const res = await fetch(
                        '/case/get_status'
                    )
                    status_info.value = await res.json()
                }

                async function get_all_users_case(){
                    users_in_case.value = null
                    const res = await fetch('/case/' + window.location.pathname.split("/").slice(-1) + '/get_all_users')
                    if(await res.status == 404){
                        display_toast(res)
                    }else{
                        users_in_case.value = await res.json()
                    }
                }


                async function delete_case(case_id){
                    const res = await fetch('/case/' + case_id.toString() + '/delete')
                    if (await res.status == 200)
                        return window.location.href="/case"
                    display_toast(res)
                }

                async function complete_case(case_loc){
                    const res = await fetch('/case/' + case_loc.id + '/complete_case')
                    if (await res.status == 200){
                        if(status_info.value.status[case_loc.status_id -1].name == 'Finished'){
                            for(let i in status_info.value.status){
                                if(status_info.value.status[i].name == 'Created')
                                case_loc.status_id = status_info.value.status[i].id
                            }
                            if(case_loc.status_id == status)
                                case_loc.status_id = 1

                                await fetch('/case/' + case_loc.id + '/change_status',{
                                headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                method: "POST",
                                body: JSON.stringify({"status": case_loc.status_id})
                            })
                        }else{
                            for(let i in status_info.value.status){
                                if(status_info.value.status[i].name == 'Finished'){
                                    case_loc.status_id = status_info.value.status[i].id
                                    await fetch('/case/' + case_loc.id + '/change_status',{
                                        headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                        method: "POST",
                                        body: JSON.stringify({"status": case_loc.status_id})
                                    })
                                    break
                                }
                            }
                        }
                        return window.location.href="/case"
                    }
                    display_toast(res)
                }

                async function remove_org_case(cases_info, org){
                    const res = await fetch('/case/' + cases_info.case.id + '/remove_org/' + org.id)
                    if (await res.status == 200){
                        let index = cases_info.orgs_in_case.indexOf(org)
                        if(index > -1)
                            cases_info.orgs_in_case.splice(index, 1)
                    }
                    display_toast(res)
                }

                async function fork_case(case_id){
                    if(await fetch_case_title($("#case_title_fork").val())){
                        $("#collapseForkBody").append(
                            $("<span>").text("Already exist").css("color", 'red')
                        )
                    }else{
                        const res = await fetch("/case/" + case_id + "/fork",{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"case_title_fork": $("#case_title_fork").val()})
                        })
                        let loc = await res.json()
                        window.location.href="/case/" + loc["new_case_id"]
                    }
                }

                async function fetch_case_title(case_title_fork){
                    const res = await fetch("/case/check_case_title_exist?title="+case_title_fork)
                    let loc = await res.json()
                    if(loc["title_already_exist"]){
                        return true
                    }
                    return false
                }


                async function create_template(case_loc){
                    if(await fetch_case_template_title($("#case_title_template").val())){
                        $("#collapseTemplateBody").append(
                            $("<span>").text("Already exist").css("color", 'red')
                        )
                    }else{
                        const res = await fetch("/case/" + case_loc.id + "/create_template",{
                            headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                            method: "POST",
                            body: JSON.stringify({"case_title_template": $("#case_title_template").val()})
                        })
                        let loc = await res.json()
                        window.location.href="/tools/template/case/" + loc["template_id"]
                    }
                }
                async function fetch_case_template_title(case_title_template){
                    const res = await fetch("/case/check_case_template_title_exist?title="+case_title_template)
                    let loc = await res.json()
                    if(loc["title_already_exist"]){
                        return true
                    }
                    return false
                }

                function onInput(e){
                    cases_info.value.tasks = []
                    if(e.target.value){
                        cases_info.value.tasks = loc_tasks_list.filter((task) => {
                            return task.title.toLowerCase().includes(e.target.value.toLowerCase())
                        })
                    }else{
                        cases_info.value.tasks = asc_desc_filter()
                    }
                }


                function scrollIntoSelectedElement() {
                    const url = new URL(location.href)
                    const task_id = url.hash.slice(1)
                    if(task_id){
                        const taskElem = document.getElementById(`${task_id}`)
                        if (taskElem) {
                            taskElem.scrollIntoView({ behavior: "smooth" });
                        }
                    }
                }

                async function active_tab(is_main){
                    if(is_main){
                        main_tab.value = true
                        if ( !document.getElementById("tab-main").classList.contains("active") ){
                            document.getElementById("tab-main").classList.add("active")
                            document.getElementById("tab-history").classList.remove("active")
                            await nextTick()
                            $('.select2-select').select2({
                                theme: 'bootstrap-5',
                                width: '50%',
                                closeOnSelect: false
                            })
                        }
                    }else{
                        main_tab.value = false
                        if ( !document.getElementById("tab-history").classList.contains("active") ){
                            document.getElementById("tab-history").classList.add("active")
                            document.getElementById("tab-main").classList.remove("active")
                        }
                    }
                }


                fetchCase()
                fetchStatus()
                get_all_users_case()


                async function fetch_taxonomies(){
                    const res = await fetch("/case/get_taxonomies")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        taxonomies.value = loc["taxonomies"]
                    }
                }
                fetch_taxonomies()

                async function fetch_galaxies(){
                    const res = await fetch("/case/get_galaxies")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        galaxies.value = loc["galaxies"]
                    }
                }
                fetch_galaxies()

                async function fetch_tags(){
                    const res = await fetch("/case/get_tags?taxonomies=" + JSON.stringify(selected_taxo.value))
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        tags_list.value = loc["tags"]
                        $('#tags_select').trigger('change');
                    }
                }
                async function fetch_cluster(){
                    const res = await fetch("/case/get_clusters?galaxies=" + JSON.stringify(selected_galaxies.value))
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        cluster_list.value = loc["clusters"]
                        $('#clusters_select').trigger('change');
                    }
                }


                async function fetch_modules(){
                    // Get modules and instances linked on
                    const res = await fetch("/case/get_modules")
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        modules.value = loc["modules"]
                    }
                }
                fetch_modules()

                async function fetch_module_selected(module){
                    // Get modules and instances linked on
                    const res = await fetch("/case/"+ window.location.pathname.split("/").slice(-1) +"/get_instance_module?type=send_to&module="+module)
                    if(await res.status==400 ){
                        display_toast(res)
                    }else{
                        let loc = await res.json()
                        module_selected.value = loc["instances"]
                        await nextTick()
                        $('#instances_select').select2({
                            theme: 'bootstrap-5',
                            width: '50%',
                            closeOnSelect: false
                        })
                        $('#instances_select').on('change.select2', function (e) {
                            let name_instance = $(this).select2('data').map(item => item.id)
                            instances_selected.value = []
                            for( let index in module_selected.value){
                                if (name_instance.includes(module_selected.value[index].name)){
                                    if(!instances_selected.value.includes(module_selected.value[index]))
                                        instances_selected.value.push(module_selected.value[index])
                                }
                            }
                        })
                    }
                }

                async function submit_module(){
                    module_loader.value = true
                    $("#modules_errors").hide()
                    $("#instances_errors").hide()
                    if(!$("#modules_select").val() || $("#modules_select").val() == "None"){
                        $("#modules_errors").text("Select an item")
                        $("#modules_errors").show()
                    }
                    if(!$("#instances_select").val() || $("#instances_select").val().length<1){
                        $("#instances_errors").text("Select an item")
                        $("#instances_errors").show()
                    }

                    let i_s = $("#instances_select").val()
                    let int_sel = {}
                    for(let index in i_s){
                        for( let j in module_selected.value){
                            if (module_selected.value[j].name == i_s[index]){
                                let loc_val = $("#identifier_"+module_selected.value[j].id).val()
                                int_sel[module_selected.value[j].name] = loc_val
                                for(let k in instances_selected.value){
                                    if(instances_selected.value[k].name == module_selected.value[j].name){
                                        instances_selected.value[k].identifier = loc_val
                                    }
                                }
                            }
                        }
                    }
                    const res = await fetch("/case/"+ window.location.pathname.split("/").slice(-1) +"/call_module_case?module=" + $("#modules_select").val() , {
                        method: "POST",
                        body: JSON.stringify({
                            int_sel
                        }),
                        headers: {
                            "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json"
                        }
                    });
                    module_loader.value = false

                    display_toast(res, true)
                }


                onMounted(() => {
                    $('.select2-select').select2({
                        theme: 'bootstrap-5',
                        width: '50%',
                        closeOnSelect: false
                    })

                    $('#taxonomies_select').on('change.select2', function (e) {
                        selected_taxo.value = $(this).select2('data').map(item => item.id);
                        fetch_tags()
                    })
                    $('#tags_select').on('change.select2', function (e) {
                        selected_tags.value = $(this).select2('data').map(item => item.id);
                        asc_desc_filter()
                    })
                    $('#galaxies_select').on('change.select2', function (e) {
                        selected_galaxies.value = $(this).select2('data').map(item => item.id);
                        fetch_cluster()
                    })
                    $('#clusters_select').on('change.select2', function (e) {
                        selected_clusters.value = $(this).select2('data').map(item => item.id);
                        asc_desc_filter()
                    })

                    $('#modules_select').on('change.select2', function (e) {
                        if($(this).select2('data').map(item => item.id)[0] == "None"){
                            module_selected.value = []
                        }else{
                            fetch_module_selected($(this).select2('data').map(item => item.id))
                        }
                    })
                    
                    
                })
                
    
                return {
                    cases_info,
                    status_info,
                    users_in_case,
                    message_list,
                    edit_mode,
                    moment,
                    main_tab,
                    history,
                    delete_case,
                    remove_org_case,
                    complete_case,
                    fork_case,
                    create_template,
                    onInput,
                    filter_ongoing,
                    sort_by_filter,
                    asc_desc_filter,
                    active_tab,
                    submit_module,
                    getTextColor,
                    mapIcon,
                    taxonomies,
                    tags_list,
                    galaxies,
                    cluster_list,
                    modules,
                    module_selected,
                    instances_selected,
                    module_loader
                }
            }
        }).mount('.container')

    </script>
{% endblock %}