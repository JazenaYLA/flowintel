<!-- 
    Author: David Cruciani
-->
{% extends 'base.html' %}

{% block content %}
    <div>
    <h1 style="display: inline-block; font-size: xxx-large;"><a type="button" class="btn" href="/tools/template/cases"><i class="fa-solid fa-arrow-left"></i></a></h1>
    <h1 style="display: inline-block; font-size: xxx-large;">Template</h1>
    </div>
    <h2 style="display: inline-block;">{{case.id}} - {{case.title}}</h2>

    <div style="float:right; display: grid;">
        <a class="btn btn-primary btn-sm"  href="/tools/template/case/{{case.id}}/download" type="button" title="Download the case in json"><i class="fa-solid fa-download"></i></a>
        <button class="btn btn-danger btn-sm"  @click="delete_case({{case}})" title="Delete the Case"><i class="fa-solid fa-trash"></i></button>
    </div>

    <div style="float:right">
        <a class="btn btn-primary btn-sm" href="/tools/template/edit_case/{{case.id}}" type="button" title="Edit the case"><i class="fa-solid fa-pen-to-square"></i></a>
        
        <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="dropdown" aria-expanded="false" title="Create a Case from template">
            <i class="fa-solid fa-file"></i>
        </button>
        <ul class="dropdown-menu">
            <li>
                <input id="case_title_fork" placeholder="Case title"/>
                <button class="btn btn-primary btn-sm" @click="fork_case({{case.id}})">Create</button>
            </li>
        </ul>
    </div>

    {% if case.tags %}
        <div style="display: flex;">
            {% for tag in case.tags%}
                <div class="tag" title="{{tag.description}}" :style="{'background-color': '{{tag.color}}', 'color': getTextColor('{{tag.color}}')}">
                    <i class="fa-solid fa-tag" style="margin-right: 3px; margin-left: 3px;"></i>
                    {{tag.name}}
                </div>
            {%endfor%}
        </div>
    {%endif%}

    <div style="margin-top: 5px;">
        {% if case.clusters %}
            {% for cluster in case.clusters %}
                <div title="Description: &#013;{{cluster.description}}&#013;&#013; Metadata: &#013;{{cluster.meta}}">
                    <span v-html="mapIcon('{{cluster.icon}}')"></span>
                    {{cluster.tag}}
                </div>
            {%endfor%}
        {%endif%}
    </div>

    <hr>

    {% if case.description %}
    <div>
        <p>{{case.description}}</p>
        <hr>
    </div>
    {%endif%}

    <div id="top"></div>
    <div style="display: flex;">
        <h3>Tasks</h3>
        <span style="padding-left: 10px;">
            <a href="/tools/template/case/{{case.id}}/add_task" class="btn btn-primary"><i class="fa-solid fa-plus"></i></a>
        </span>
    </div>

    <template v-if="tasks_list">
        <div v-for="task,key in tasks_list" class="list-group" style="margin-bottom: 20px;">
            <div style="display:flex">
                <a class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h4 class="mb-1">[[key+1]]-[[ task.title ]]</h4>
                    </div>
                    <div class="d-flex w-100 justify-content-between">
                        <p v-if="task.description" class="card-text">[[ task.description ]]</p>
                        <p v-else class="card-text"><i style="font-size: 12px;">No description</i></p>
                    </div>
                    <div class="d-flex w-100 justify-content-between">
                        <p v-if="task.url" class="card-text">[[ task.url ]]</p>
                        <p v-else class="card-text"><i style="font-size: 12px;">No url</i></p>
                    </div>
                    <div v-for="instance in task.instances" :title="instance.description">
                        <img :src="'/static/icons/'+instance.icon" style="max-width: 30px;">
                        <i>[[instance.url]]</i>
                    </div>
                    <div class="d-flex w-100 justify-content-between">
                        <div style="display: flex;" v-if="task.tags">
                            <template v-for="tag in task.tags">
                                <div class="tag" :title="tag.description" :style="{'background-color': tag.color, 'color': getTextColor(tag.color)}">
                                    <i class="fa-solid fa-tag" style="margin-right: 3px; margin-left: 3px;"></i>
                                    [[tag.name]]
                                </div>
                            </template>
                        </div>
                        <div v-else></div>
                    </div>
                    <div class="d-flex w-100 justify-content-between">
                        <div style="display: flex;" v-if="task.clusters">
                            <template v-for="cluster in task.clusters">
                                <div :title="'Description:\n' + cluster.description + '\n\nMetadata:\n' + JSON.stringify(JSON.parse(cluster.meta), null, 4)">
                                    <span v-html="mapIcon(cluster.icon)"></span>
                                    [[cluster.tag]]
                                </div>
                            </template>
                        </div>
                        <div v-else></div>
                    </div>
                </a>
                <div v-if="!task.current_user_permission.read_only" style="display: grid;">
                    <div style="display: grid;">
                        <a class="btn btn-primary btn-sm" :href="`/tools/template/edit_task/${task.id}`" type="button" title="Edit the template"><i class="fa-solid fa-pen-to-square"></i></a>
                        <button class="btn btn-danger btn-sm" @click="remove_task({{case.id}}, task)" title="Remove the task"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template v-else>
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </template>

    <span id="goTop">[<a href="#top">Go Back Top</a>]</span>
        
{% endblock %}


{% block script %}
    <script type="module">
        const { createApp, ref, computed, onMounted } = Vue
        import {display_toast, message_list} from '/static/js/toaster.js'
        
        createApp({
            delimiters: ['[[', ']]'],
            setup() {
                const tasks_list = ref(null)

                async function fetchTasks() {
                    tasks_list.value = null
                    const res = await fetch(
                        '/tools/get_task_by_case/'+window.location.pathname.split("/").slice(-1)
                    )
                    let loc = await res.json()
                    tasks_list.value = loc["tasks"]
                }

                async function remove_task(case_id, task){
                    const res = await fetch("/tools/template/" + case_id + "/remove_task/" + task.id)
                    if(await res.status == 200){
                        let index = tasks_list.value.indexOf(task)
                        if(index > -1)
                            tasks_list.value.splice(index, 1)
                    }
                    display_toast(res)
                }

                async function delete_case(case_template){
                    const res = await fetch("/tools/template/delete_case/" + case_template.id)
                    return window.location.href = "/tools/template/cases"
                }

                async function fork_case(case_id){
                    if(await fetch_case_title($("#case_title_fork").val())){
                        $("#collapseForkBody").append(
                            $("<span>").text("Already exist").css("color", 'red')
                        )
                    }else{
                        const res = await fetch("/tools/template/create_case_from_template/" + case_id,{
                                headers: { "X-CSRFToken": $("#csrf_token").val(), "Content-Type": "application/json" },
                                method: "POST",
                                body: JSON.stringify({"case_title_fork": $("#case_title_fork").val()})
                            })
                        let loc = await res.json()
                        window.location.href="/case/" + loc["new_case_id"]
                    }
                }
                async function fetch_case_title(case_title_fork){
                    const res = await fetch("/case/get_all_case_title?title="+case_title_fork)
                    let loc = await res.json()
                    if(loc["title_already_exist"]){
                        return true
                    }
                    return false
                }

                fetchTasks()

                return {
                    message_list,
                    tasks_list,
                    remove_task,
                    delete_case,
                    fork_case,
                    getTextColor,
                    mapIcon
                }
            }
        }).mount('.container')

    </script>
{% endblock %}